<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noodle Concierge Editor - Client Access</title>
    <script src="https://cdn.tiny.cloud/1/j5zovf5oihbeh6drm8cljk1lcttgms97vr01owd506v7rr70/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
            background-color: #f5f5f5;
        }
        .editor-container {
            background: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .control-panel {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 1px solid #cbd5e1;
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .header-content {
            display: grid;
            grid-template-columns: 1fr auto auto;
            grid-template-rows: auto;
            gap: 24px;
            align-items: center;
        }
        .title-section {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .main-title {
            color: #1678F2;
            margin: 0;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.025em;
            line-height: 1.2;
        }
        .tagline {
            color: #64748b;
            margin: 0;
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 0.01em;
        }
        .utility-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .utility-button {
            background: transparent;
            color: #374151;
            border: 2px solid #d1d5db;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            transition: all 0.2s ease;
        }
        .utility-button:hover {
            border-color: #1678F2;
            color: #1678F2;
            background: rgba(22, 120, 242, 0.05);
        }
        .form-section-complete {
            display: flex;
            align-items: flex-end;
            gap: 16px;
        }
        .send-button {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
            transition: all 0.2s ease;
        }
        .send-button:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
            transform: translateY(-1px);
        }
        .save-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #10B981;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            display: none;
            font-size: 12px;
        }
        .draft-status {
            font-size: 12px;
            color: #64748b;
            margin-top: 8px;
            font-weight: 500;
            text-align: center;
        }
        .draft-restored {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 1px solid #3b82f6;
            color: #1e40af;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 13px;
            font-weight: 500;
            display: none;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
        }
        .field-container {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .field-label {
            color: #374151;
            font-size: 13px;
            font-weight: 600;
            margin: 0;
        }
        .field-input {
            padding: 10px 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: white;
            transition: all 0.2s ease;
            width: 140px;
        }
        .field-input:focus {
            outline: none;
            border-color: #1678F2;
            box-shadow: 0 0 0 3px rgba(22, 120, 242, 0.1);
        }
        .field-error {
            border-color: #ef4444 !important;
            background-color: #fef2f2;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
        }
        .field-valid {
            border-color: #10B981 !important;
            background-color: #f0fdf4;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
        }
        .error-message {
            color: #ef4444;
            font-size: 11px;
            font-weight: 500;
            margin-top: 2px;
            min-height: 14px;
        }
        .submit-disabled {
            background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%) !important;
            cursor: not-allowed !important;
            box-shadow: none !important;
            transform: none !important;
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <div class="draft-restored" id="draftRestored">
            Draft restored from previous session
        </div>
        <div class="control-panel">
            <div class="header-content">
                <div class="title-section">
                    <h1 class="main-title">Noodle Concierge Document Editor</h1>
                    <p class="tagline">Quick Document Editing</p>
                </div>
                <div class="utility-buttons">
                    <button type="button" class="utility-button" onclick="revertToOriginal()">
                        Revert to Original
                    </button>
                </div>
                <div class="form-section-complete">
                    <div class="field-container">
                        <label class="field-label">Your Name</label>
                        <input type="text" name="client_name" id="clientName" required class="field-input">
                        <div class="error-message" id="nameError"></div>
                    </div>
                    <div class="field-container">
                        <label class="field-label">Email Address</label>
                        <input type="email" name="client_email" id="clientEmail" required class="field-input">
                        <div class="error-message" id="emailError"></div>
                    </div>
                    <form id="documentForm" action="https://formspree.io/f/movlvgpa" method="POST" style="display: contents;">
                        <input type="hidden" name="html_content" id="htmlContent">
                        <input type="hidden" name="client_name" id="hiddenClientName">
                        <input type="hidden" name="client_email" id="hiddenClientEmail">
                        <button type="submit" class="send-button" id="submitButton">
                            Send to Fahd
                        </button>
                    </form>
                </div>
            </div>
            <div class="draft-status" id="draftStatus">
                Auto-saved locally
            </div>
        </div>

        <textarea id="editor"></textarea>
    </div>

    <div class="save-indicator" id="saveIndicator">
        Document saved automatically
    </div>

    <script>
        // Draft management functions
        const DRAFT_KEY = 'noodle-concierge-draft';
        let autoSaveTimeout;
        let originalContent = '';
        let contentLoadingPromise = null;
        
        function saveDraft() {
            try {
                if (!tinymce.get('editor')) return;
                
                const draftData = {
                    content: tinymce.get('editor').getContent(),
                    clientName: document.getElementById('clientName').value,
                    clientEmail: document.getElementById('clientEmail').value,
                    savedAt: new Date().toISOString(),
                    version: '1.0'
                };
                
                localStorage.setItem(DRAFT_KEY, JSON.stringify(draftData));
                updateDraftStatus('Draft saved locally');
            } catch (error) {
                console.warn('Could not save draft to localStorage:', error);
            }
        }
        
        function loadDraft() {
            try {
                const draftJson = localStorage.getItem(DRAFT_KEY);
                if (!draftJson) return null;
                
                return JSON.parse(draftJson);
            } catch (error) {
                console.warn('Could not load draft from localStorage:', error);
                clearDraft(); // Clear corrupted data
                return null;
            }
        }
        
        function clearDraft() {
            try {
                localStorage.removeItem(DRAFT_KEY);
                updateDraftStatus('Your work is automatically saved locally');
            } catch (error) {
                console.warn('Could not clear draft:', error);
            }
        }
        
        function hasDraft() {
            try {
                return localStorage.getItem(DRAFT_KEY) !== null;
            } catch (error) {
                return false;
            }
        }
        
        function updateDraftStatus(message) {
            const statusElement = document.getElementById('draftStatus');
            if (statusElement) {
                statusElement.textContent = message;
            }
        }
        
        function debouncedAutoSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(saveDraft, 3000); // 3 second delay
        }
        
        function restoreDraftIfExists() {
            const draft = loadDraft();
            if (draft && draft.content) {
                // Show restoration notification
                const restoredNotification = document.getElementById('draftRestored');
                restoredNotification.style.display = 'block';
                setTimeout(() => {
                    restoredNotification.style.display = 'none';
                }, 5000);
                
                // Restore form fields
                if (draft.clientName) {
                    document.getElementById('clientName').value = draft.clientName;
                }
                if (draft.clientEmail) {
                    document.getElementById('clientEmail').value = draft.clientEmail;
                }
                
                // Update status with timestamp
                const savedDate = new Date(draft.savedAt);
                updateDraftStatus(`Draft from ${savedDate.toLocaleDateString()} ${savedDate.toLocaleTimeString()}`);
                
                return draft.content;
            }
            return null;
        }
        
        // Dynamic content loading functions
        async function loadContentFromSource() {
            try {
                const response = await fetch('./noodle_concierge_for_PMs.html');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const html = await response.text();
                
                // Parse HTML and extract body content
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Extract content between running elements and body
                const bodyContent = extractMainContent(doc);
                return bodyContent;
            } catch (error) {
                console.error('Failed to load source content:', error);
                // Fallback to a basic structure if loading fails
                return getFallbackContent();
            }
        }
        
        function extractMainContent(doc) {
            // Find the main content area by looking for the sections we want
            const body = doc.body;
            if (!body) {
                throw new Error('No body found in source document');
            }
            
            // Create a container for the extracted content
            const contentContainer = document.createElement('div');
            
            // Extract header section
            const header = body.querySelector('.header');
            if (header) {
                contentContainer.appendChild(header.cloneNode(true));
            }
            
            // Extract all the main content sections (Problem, Solution, Value, Next Steps)
            const mainSections = body.querySelectorAll('.col-12');
            mainSections.forEach(section => {
                contentContainer.appendChild(section.cloneNode(true));
            });
            
            // Extract footer
            const footer = body.querySelector('.footer');
            if (footer) {
                contentContainer.appendChild(footer.cloneNode(true));
            }
            
            return contentContainer.innerHTML;
        }
        
        function getFallbackContent() {
            return `
                <div class="header" style="margin-bottom: 0.3rem;">
                    <img src="rectangle_logo_and_name.png" alt="Noodle Seed" class="logo-image">
                    <h1 class="hero-title">Noodle Concierge</h1>
                    <p class="hero-subtitle">AI-Powered Software that Contacts, Negotiates, and Retains Tenants For You</p>
                    <p class="hero-tagline" style="color: #10B981; font-weight: 600;">$0 Upfront Cost – Pay Only for Saved Renewals</p>
                </div>
                
                <div class="col-12">
                    <div class="card" style="border-left-color: #ef4444;">
                        <div class="card-header" style="background: #ef4444;">CONTENT LOADING ERROR</div>
                        <p style="text-align: center; padding: 1rem; color: #374151;">
                            Unable to load content from source file. Please refresh the page or contact support.
                        </p>
                    </div>
                </div>
                
                <div class="footer">
                    <p><strong>Fahd Rafi</strong>, Founder, TheNoodleSeed Corporation • noodleseed.com • fahd@noodleseed.com</p>
                </div>
            `;
        }
        
        // Initialize content loading
        function initializeContentLoading() {
            if (!contentLoadingPromise) {
                contentLoadingPromise = loadContentFromSource();
            }
            return contentLoadingPromise;
        }
        
        // Form validation functions
        function validateName(name) {
            const trimmedName = name.trim();
            
            if (!trimmedName) {
                return { isValid: false, message: 'Please enter your name' };
            }
            
            if (trimmedName.length < 2) {
                return { isValid: false, message: 'Name must be at least 2 characters' };
            }
            
            if (trimmedName.length > 50) {
                return { isValid: false, message: 'Name must be less than 50 characters' };
            }
            
            // Allow letters, spaces, hyphens, apostrophes, and common accented characters
            const namePattern = /^[a-zA-ZÀ-ÿ\s\-'\.]+$/;
            if (!namePattern.test(trimmedName)) {
                return { isValid: false, message: 'Name can only contain letters, spaces, hyphens, and apostrophes' };
            }
            
            return { isValid: true, message: '' };
        }
        
        function validateEmail(email) {
            const trimmedEmail = email.trim().toLowerCase();
            
            if (!trimmedEmail) {
                return { isValid: false, message: 'Please enter your email address' };
            }
            
            if (trimmedEmail.length > 100) {
                return { isValid: false, message: 'Email must be less than 100 characters' };
            }
            
            // Comprehensive email validation pattern
            const emailPattern = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
            
            if (!emailPattern.test(trimmedEmail)) {
                return { isValid: false, message: 'Please enter a valid email address' };
            }
            
            // Additional checks for common mistakes
            if (trimmedEmail.includes('..') || trimmedEmail.startsWith('.') || trimmedEmail.endsWith('.')) {
                return { isValid: false, message: 'Please enter a valid email address' };
            }
            
            return { isValid: true, message: '' };
        }
        
        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId === 'clientName' ? 'nameError' : 'emailError');
            
            field.classList.remove('field-valid');
            field.classList.add('field-error');
            errorElement.textContent = message;
        }
        
        function showFieldValid(fieldId) {
            const field = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId === 'clientName' ? 'nameError' : 'emailError');
            
            field.classList.remove('field-error');
            field.classList.add('field-valid');
            errorElement.textContent = '';
        }
        
        function clearFieldValidation(fieldId) {
            const field = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId === 'clientName' ? 'nameError' : 'emailError');
            
            field.classList.remove('field-error', 'field-valid');
            errorElement.textContent = '';
        }
        
        function validateForm() {
            const nameField = document.getElementById('clientName');
            const emailField = document.getElementById('clientEmail');
            
            const nameValidation = validateName(nameField.value);
            const emailValidation = validateEmail(emailField.value);
            
            // Update visual feedback
            if (nameValidation.isValid) {
                showFieldValid('clientName');
            } else {
                showFieldError('clientName', nameValidation.message);
            }
            
            if (emailValidation.isValid) {
                showFieldValid('clientEmail');
            } else {
                showFieldError('clientEmail', emailValidation.message);
            }
            
            const isFormValid = nameValidation.isValid && emailValidation.isValid;
            updateSubmitButton(isFormValid);
            
            return isFormValid;
        }
        
        function updateSubmitButton(isValid) {
            const submitButton = document.getElementById('submitButton');
            
            if (isValid) {
                submitButton.classList.remove('submit-disabled');
                submitButton.disabled = false;
            } else {
                submitButton.classList.add('submit-disabled');
                submitButton.disabled = true;
            }
        }

        tinymce.init({
            selector: '#editor',
            height: 800,
            
            // Plugins for functionality
            plugins: [
                'advlist', 'autolink', 'lists', 'link', 'image', 'charmap',
                'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                'insertdatetime', 'media', 'table', 'help', 'wordcount', 'save',
                'importcss', 'autosave'
            ],
            
            // Toolbar configuration
            toolbar: 'save | undo redo | formatselect | bold italic underline strikethrough | ' +
                    'forecolor backcolor | alignleft aligncenter alignright alignjustify | ' +
                    'bullist numlist outdent indent | table | link image | ' +
                    'removeformat | help | fullscreen | code',
            
            // Content CSS - load your custom styles
            content_css: './noodle-styles.css',
            
            // Import CSS classes for formatting dropdown
            importcss_append: true,
            importcss_selector_filter: function(selector) {
                // Include your custom classes in the format dropdown
                return /\.(hero-title|hero-subtitle|hero-tagline|card|card-header|text-blue|text-green|text-orange|amount|descriptor|footer)/.test(selector);
            },
            
            // Auto-save functionality
            autosave_interval: '30s',
            autosave_restore_when_empty: true,
            
            // Setup function to load content and configure
            setup: function (editor) {
                // Pre-load your document content dynamically
                editor.on('init', async function () {
                    try {
                        // Show loading state
                        editor.setContent('<div style="text-align: center; padding: 2rem; color: #666;">Loading content...</div>');
                        
                        // Load content dynamically from source file
                        originalContent = await initializeContentLoading();
                        
                        // Try to restore draft first, otherwise load original content
                        const draftContent = restoreDraftIfExists();
                        const contentToLoad = draftContent || originalContent;
                        
                        editor.setContent(contentToLoad);
                        
                        // Update draft status
                        updateDraftStatus('Content loaded from source file');
                        
                    } catch (error) {
                        console.error('Failed to load content:', error);
                        // Fallback to error content
                        const fallbackContent = getFallbackContent();
                        originalContent = fallbackContent;
                        editor.setContent(fallbackContent);
                        updateDraftStatus('Error loading content - using fallback');
                    }
                });
                
                // Auto-save on content changes
                editor.on('change', function() {
                    showSaveIndicator();
                    debouncedAutoSave();
                });
                
                // Auto-save on typing (with debouncing)
                editor.on('keyup', function() {
                    debouncedAutoSave();
                });
                
                // Custom save function
                editor.addCommand('mceSave', function() {
                    saveDraft();
                });
            }
        });
        
        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }
        
        // Handle form submission
        document.addEventListener('DOMContentLoaded', function() {
            // Get form field references
            const nameField = document.getElementById('clientName');
            const emailField = document.getElementById('clientEmail');
            
            // Initialize submit button state (disabled until valid)
            updateSubmitButton(false);
            
            // Add real-time validation listeners
            nameField.addEventListener('input', function() {
                const validation = validateName(this.value);
                if (validation.isValid) {
                    showFieldValid('clientName');
                } else if (this.value.trim()) { // Only show errors if they've typed something
                    showFieldError('clientName', validation.message);
                } else {
                    clearFieldValidation('clientName');
                }
                validateForm();
                debouncedAutoSave();
            });
            
            nameField.addEventListener('blur', function() {
                if (this.value.trim()) {
                    const validation = validateName(this.value);
                    if (validation.isValid) {
                        showFieldValid('clientName');
                    } else {
                        showFieldError('clientName', validation.message);
                    }
                    validateForm();
                }
            });
            
            emailField.addEventListener('input', function() {
                const validation = validateEmail(this.value);
                if (validation.isValid) {
                    showFieldValid('clientEmail');
                } else if (this.value.trim()) { // Only show errors if they've typed something
                    showFieldError('clientEmail', validation.message);
                } else {
                    clearFieldValidation('clientEmail');
                }
                validateForm();
                debouncedAutoSave();
            });
            
            emailField.addEventListener('blur', function() {
                if (this.value.trim()) {
                    const validation = validateEmail(this.value);
                    if (validation.isValid) {
                        showFieldValid('clientEmail');
                    } else {
                        showFieldError('clientEmail', validation.message);
                    }
                    validateForm();
                }
            });
            
            // Validate form after restore (if fields are populated)
            setTimeout(() => {
                if (nameField.value.trim() || emailField.value.trim()) {
                    validateForm();
                }
            }, 500);
            
            document.getElementById('documentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Validate form before submission
                if (!validateForm()) {
                    // Focus on first invalid field
                    const nameField = document.getElementById('clientName');
                    const emailField = document.getElementById('clientEmail');
                    
                    if (!validateName(nameField.value).isValid) {
                        nameField.focus();
                    } else if (!validateEmail(emailField.value).isValid) {
                        emailField.focus();
                    }
                    return; // Stop submission if validation fails
                }
                
                // Get the current document content from TinyMCE
                const content = tinymce.get('editor').getContent();
                
                // Set the hidden fields with the form data
                document.getElementById('htmlContent').value = content;
                document.getElementById('hiddenClientName').value = document.getElementById('clientName').value;
                document.getElementById('hiddenClientEmail').value = document.getElementById('clientEmail').value;
                
                // Show loading state
                const submitButton = this.querySelector('button[type="submit"]');
                const originalText = submitButton.textContent;
                submitButton.textContent = 'Submitting...';
                submitButton.disabled = true;
                
                // Submit the form
                fetch(this.action, {
                    method: 'POST',
                    body: new FormData(this),
                    headers: {
                        'Accept': 'application/json'
                    }
                }).then(response => {
                    if (response.ok) {
                        clearDraft(); // Clear saved draft on successful submission
                        showSuccessMessage();
                    } else {
                        throw new Error('Form submission failed');
                    }
                }).catch(error => {
                    showErrorMessage();
                }).finally(() => {
                    submitButton.textContent = originalText;
                    submitButton.disabled = false;
                });
            });
        });
        
        function showSuccessMessage() {
            const successModal = document.createElement('div');
            successModal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            successModal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 10px; max-width: 400px; text-align: center;">
                    <h2 style="color: #10B981; margin-bottom: 20px;">Document Submitted Successfully!</h2>
                    <p style="margin-bottom: 20px;">Your edited document has been sent to Fahd. You should receive a confirmation email shortly.</p>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: #10B981; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px;">
                        Great!
                    </button>
                </div>
            `;
            
            document.body.appendChild(successModal);
        }
        
        function showErrorMessage() {
            const errorModal = document.createElement('div');
            errorModal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            errorModal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 10px; max-width: 400px; text-align: center;">
                    <h2 style="color: #ef4444; margin-bottom: 20px;">Submission Failed</h2>
                    <p style="margin-bottom: 20px;">There was an issue submitting your document. Please try again or contact Fahd directly at:</p>
                    <p style="font-weight: bold; color: #1678F2; margin-bottom: 20px;">fahd@noodleseed.com</p>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: #1678F2; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px;">
                        OK
                    </button>
                </div>
            `;
            
            document.body.appendChild(errorModal);
        }
        
        // Utility functions
        async function revertToOriginal() {
            if (confirm('Are you sure you want to revert to the original document? This will clear all your changes and saved draft.')) {
                try {
                    // Show loading state
                    if (tinymce.get('editor')) {
                        tinymce.get('editor').setContent('<div style="text-align: center; padding: 2rem; color: #666;">Reloading original content...</div>');
                    }
                    
                    // Fetch fresh content from source file
                    contentLoadingPromise = null; // Reset the promise to force fresh load
                    originalContent = await initializeContentLoading();
                    
                    // Clear the editor content and restore original
                    if (tinymce.get('editor')) {
                        tinymce.get('editor').setContent(originalContent);
                    }
                    
                    // Clear the draft
                    clearDraft();
                    
                    // Clear form fields
                    document.getElementById('clientName').value = '';
                    document.getElementById('clientEmail').value = '';
                    clearFieldValidation('clientName');
                    clearFieldValidation('clientEmail');
                    updateSubmitButton(false);
                    
                    // Show success message
                    showSuccessNotification('Document reverted to latest original');
                    updateDraftStatus('Reverted to latest source content');
                    
                } catch (error) {
                    console.error('Failed to revert to original:', error);
                    showErrorNotification('Failed to load original content. Please refresh the page.');
                }
            }
        }
        
        // PDF Configuration
        const pdfConfig = {
            margin: [0.3, 0.3, 0.3, 0.3],
            filename: '',
            image: { 
                type: 'jpeg', 
                quality: 0.98
            },
            html2canvas: {
                scale: 2,
                useCORS: true,
                allowTaint: false,
                backgroundColor: '#ffffff',
                letterRendering: true,
                logging: true,
                scrollX: 0,
                scrollY: 0,
                x: 0,
                y: 0,
                width: null,  // Let html2canvas determine width automatically
                height: null, // Let html2canvas determine height automatically
                windowWidth: 1200,
                windowHeight: 1600
            },
            jsPDF: {
                unit: 'pt',
                format: 'letter',
                orientation: 'portrait',
                compress: true,
                precision: 2
            },
            pagebreak: {
                mode: ['avoid-all', 'css', 'legacy'],
                avoid: ['tr', '.card', '.header']
            }
        };

        // Font Loading Management
        async function ensureFontsLoaded() {
            try {
                const fontFaces = [
                    new FontFace('Poppins', 'url(https://fonts.gstatic.com/s/poppins/v20/pxiByp8kv8JHgFVrLCz7Z1xlFQ.woff2)', {
                        weight: '400',
                        style: 'normal'
                    }),
                    new FontFace('Poppins', 'url(https://fonts.gstatic.com/s/poppins/v20/pxiByp8kv8JHgFVrLEj6Z1xlFQ.woff2)', {
                        weight: '600',
                        style: 'normal'
                    }),
                    new FontFace('Poppins', 'url(https://fonts.gstatic.com/s/poppins/v20/pxiByp8kv8JHgFVrLBz5Z1xlFQ.woff2)', {
                        weight: '700',
                        style: 'normal'
                    })
                ];
                
                const fontPromises = fontFaces.map(async (font) => {
                    await font.load();
                    document.fonts.add(font);
                });
                
                await Promise.all(fontPromises);
                await document.fonts.ready;
                await new Promise(resolve => setTimeout(resolve, 500));
            } catch (error) {
                console.warn('Font loading failed, continuing with system fonts:', error);
            }
        }

        // Document Optimization Functions
        function createPrintableDocument() {
            const content = tinymce.get('editor').getContent();
            
            // Create a complete HTML document with styles
            const printContainer = document.createElement('div');
            printContainer.id = 'pdf-print-container';
            
            // Include the CSS styles inline
            const cssContent = `
                @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,400&display=swap');
                
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }
                
                body, .pdf-optimized-content {
                    font-family: 'Poppins', sans-serif !important;
                    background-color: white;
                    color: #111827;
                    line-height: 1.3;
                    width: 8.5in !important;
                    max-width: 8.5in !important;
                    margin: 0 !important;
                    padding: 0.3in 0.4in !important;
                    font-weight: 400;
                    font-size: 0.85rem;
                    page-break-inside: avoid;
                    box-sizing: border-box !important;
                }
                
                .text-blue { color: #1678F2 !important; }
                .text-green { color: #10B981 !important; }
                .text-orange { color: #F59E0B !important; }
                .text-grey { color: #374151 !important; }
                .bg-blue { background-color: #1d4ed8 !important; }
                .bg-green { background-color: #059669 !important; }
                .bg-orange { background-color: #d97706 !important; }
                .bg-light-green { background-color: #ecfdf5 !important; }
                .bg-light-blue { background-color: #eff6ff !important; }
                .bg-light-orange { background-color: #fff7ed !important; }
                
                .header {
                    text-align: center !important;
                    border-bottom: 2px solid #1678F2 !important;
                    padding-bottom: 0.2rem !important;
                    margin-bottom: 0.2rem !important;
                    width: 100% !important;
                }
                
                .hero-title {
                    font-family: 'Poppins', sans-serif !important;
                    font-size: 1.4rem !important;
                    font-weight: 700 !important;
                    color: #1678F2 !important;
                    margin-bottom: 0.1rem !important;
                    line-height: 1.1 !important;
                    letter-spacing: -0.01em !important;
                    text-align: center !important;
                }
                
                .hero-subtitle {
                    font-size: 1rem !important;
                    color: #374151 !important;
                    margin-bottom: 0.1rem !important;
                    font-weight: 400 !important;
                    line-height: 1.3 !important;
                    text-align: center !important;
                }
                
                .hero-tagline {
                    font-size: 1rem !important;
                    color: #10B981 !important;
                    font-weight: 600 !important;
                    line-height: 1.3 !important;
                    letter-spacing: 0.01em !important;
                    text-align: center !important;
                }
                
                .card {
                    background: white !important;
                    border-radius: 0 12px 0 12px !important;
                    padding: 0.2rem 0.2rem 0.2rem 0.3rem !important;
                    border-left: 3px solid #1678F2 !important;
                    margin-bottom: 0.15rem !important;
                    height: 100% !important;
                    text-align: left !important;
                    line-height: 1.3 !important;
                    width: 100% !important;
                    box-sizing: border-box !important;
                }
                
                .card-header {
                    background: #1678F2 !important;
                    color: white !important;
                    padding: 0.3rem 0.4rem !important;
                    border-radius: 0 12px 0 12px !important;
                    margin: -0.3rem -0.3rem 0.4rem -0.4rem !important;
                    font-size: 0.9rem !important;
                    font-weight: 700 !important;
                    text-transform: uppercase !important;
                    letter-spacing: 0.75px !important;
                    line-height: 1.2 !important;
                    width: calc(100% + 0.7rem) !important;
                    box-sizing: border-box !important;
                }
                
                .col-12 {
                    width: 100% !important;
                    margin-bottom: 0.2rem !important;
                    box-sizing: border-box !important;
                }
                
                .footer {
                    text-align: center;
                    font-size: 0.85rem;
                    color: #1f2937;
                    border-top: 2px solid #1678F2;
                    padding-top: 0.4rem;
                    font-weight: 600;
                    background: linear-gradient(135deg, #f8fafc 0%, #f8fafc 100%);
                    padding: 0.5rem;
                    border-radius: 0 12px 0 12px;
                    margin-top: 0.3rem;
                }
            `;
            
            // Create style element
            const styleElement = document.createElement('style');
            styleElement.textContent = cssContent;
            
            // Position container optimally for PDF generation
            printContainer.style.cssText = `
                position: absolute;
                top: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 8.5in;
                min-height: 11in;
                background: white;
                z-index: 9999;
                visibility: visible;
                overflow: visible;
                padding: 0;
                margin: 0;
                box-sizing: border-box;
                border: 2px solid red;
            `;
            
            // Add debug info
            printContainer.setAttribute('data-debug', 'pdf-container');
            
            // Add styles and content
            printContainer.appendChild(styleElement);
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'pdf-optimized-content';
            contentDiv.style.cssText = `
                width: 8.5in;
                padding: 0;
                margin: 0;
                box-sizing: border-box;
                overflow: visible;
                position: relative;
                border: 2px solid blue;
            `;
            contentDiv.setAttribute('data-debug', 'pdf-content');
            contentDiv.innerHTML = content;
            printContainer.appendChild(contentDiv);
            
            document.body.appendChild(printContainer);
            return printContainer;
        }

        function optimizeClonedDocument(clonedDoc) {
            // Remove contenteditable attributes
            clonedDoc.querySelectorAll('[contenteditable]').forEach(el => {
                el.removeAttribute('contenteditable');
            });
            
            // Fix layout issues
            clonedDoc.querySelectorAll('*').forEach(el => {
                const computedStyle = window.getComputedStyle(el);
                if (computedStyle.position === 'fixed' || computedStyle.position === 'sticky') {
                    el.style.position = 'static';
                }
                
                // Force consistent colors
                if (el.classList.contains('text-blue')) {
                    el.style.color = '#1678F2';
                }
                if (el.classList.contains('text-green')) {
                    el.style.color = '#10B981';
                }
                if (el.classList.contains('text-orange')) {
                    el.style.color = '#F59E0B';
                }
            });
            
            clonedDoc.body.style.fontFamily = "'Poppins', sans-serif";
            return clonedDoc;
        }

        async function waitForImages(container) {
            const images = container.querySelectorAll('img');
            const imagePromises = Array.from(images).map(img => {
                if (img.complete) return Promise.resolve();
                
                return new Promise((resolve) => {
                    img.onload = resolve;
                    img.onerror = () => {
                        img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PC9zdmc+';
                        resolve();
                    };
                    
                    setTimeout(() => {
                        img.onerror = null;
                        img.onload = null;
                        resolve();
                    }, 5000);
                });
            });
            
            await Promise.all(imagePromises);
        }

        // PDF Generation Function
        async function downloadPDF() {
            let printContainer = null;
            try {
                showPDFLoadingIndicator();
                updatePDFProgress('Loading fonts...');
                
                await ensureFontsLoaded();
                
                updatePDFProgress('Preparing document...');
                printContainer = createPrintableDocument();
                
                updatePDFProgress('Loading images...');
                await waitForImages(printContainer);
                
                updatePDFProgress('Optimizing layout...');
                
                // Calculate scaling to fit content on one page
                const contentDiv = printContainer.querySelector('.pdf-optimized-content');
                const pageHeight = 11 * 72; // 11 inches in points
                const marginHeight = 0.6 * 72; // Top and bottom margins
                const availableHeight = pageHeight - marginHeight;
                
                // Force layout calculation
                contentDiv.style.height = 'auto';
                
                // Measure actual content height after layout
                await new Promise(resolve => setTimeout(resolve, 100));
                const actualHeight = contentDiv.scrollHeight;
                
                console.log(`Content height: ${actualHeight}px, Available: ${availableHeight}px`);
                
                if (actualHeight > availableHeight) {
                    const scale = Math.min(0.98, availableHeight / actualHeight);
                    console.log(`Applying scale: ${scale}`);
                    
                    // Apply scaling without affecting positioning
                    contentDiv.style.transform = `scale(${scale})`;
                    contentDiv.style.transformOrigin = 'top left';
                    
                    // Adjust container height to match scaled content
                    const scaledHeight = actualHeight * scale;
                    printContainer.style.height = `${scaledHeight + marginHeight}px`;
                } else {
                    printContainer.style.height = `${pageHeight}px`;
                }
                
                updatePDFProgress('Generating PDF...');
                
                // Add debugging to check container dimensions
                const containerRect = printContainer.getBoundingClientRect();
                const contentRect = contentDiv.getBoundingClientRect();
                console.log('Container dimensions:', {
                    width: containerRect.width,
                    height: containerRect.height,
                    left: containerRect.left,
                    top: containerRect.top
                });
                console.log('Content dimensions:', {
                    width: contentRect.width,
                    height: contentRect.height,
                    scrollHeight: contentDiv.scrollHeight,
                    scrollWidth: contentDiv.scrollWidth
                });
                
                // Container is already visible from createPrintableDocument
                // Wait a moment for rendering to settle
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const filename = `noodle-concierge-document-${timestamp}.pdf`;
                
                const finalConfig = {
                    ...pdfConfig,
                    filename: filename
                };
                
                await html2pdf()
                    .from(printContainer)
                    .set(finalConfig)
                    .save();
                
                showPDFSuccessNotification('PDF downloaded successfully');
                
            } catch (error) {
                console.error('PDF generation failed:', error);
                handlePDFError(error);
            } finally {
                if (printContainer && printContainer.parentNode) {
                    printContainer.parentNode.removeChild(printContainer);
                }
                hidePDFLoadingIndicator();
            }
        }

        // Loading Indicator Functions
        function showPDFLoadingIndicator() {
            const loader = document.createElement('div');
            loader.id = 'pdf-loader';
            loader.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                            background: rgba(0,0,0,0.8); z-index: 10000; 
                            display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 12px; 
                                text-align: center; max-width: 400px;">
                        <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; 
                                    border-top: 4px solid #1678F2; border-radius: 50%; 
                                    animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                        <h3 style="color: #1678F2; margin-bottom: 10px;">Generating PDF</h3>
                        <p style="color: #666; margin: 0;">This may take a few moments...</p>
                        <div id="pdf-progress" style="margin-top: 15px; font-size: 14px; color: #888;">
                            Preparing document...
                        </div>
                    </div>
                </div>
            `;
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(loader);
        }

        function updatePDFProgress(message) {
            const progressElement = document.getElementById('pdf-progress');
            if (progressElement) {
                progressElement.textContent = message;
            }
        }

        function hidePDFLoadingIndicator() {
            const loader = document.getElementById('pdf-loader');
            if (loader && loader.parentNode) {
                loader.parentNode.removeChild(loader);
            }
        }

        // Error Handling
        function handlePDFError(error) {
            if (error.message.includes('canvas')) {
                showPDFErrorNotification('PDF generation failed due to content complexity. Please try refreshing the page.');
            } else if (error.message.includes('memory')) {
                showPDFErrorNotification('PDF generation failed due to document size. Try reducing content.');
            } else {
                showPDFErrorNotification('PDF generation failed. Please try again or contact support.');
            }
        }

        function showPDFSuccessNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                background: #10B981; color: white; padding: 12px 20px;
                border-radius: 8px; font-size: 14px; font-weight: 500;
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 4000);
        }

        function showPDFErrorNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                background: #ef4444; color: white; padding: 12px 20px;
                border-radius: 8px; font-size: 14px; font-weight: 500;
                box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 6000);
        }
        
        function showSuccessNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                background: #10B981; color: white; padding: 12px 20px;
                border-radius: 8px; font-size: 14px; font-weight: 500;
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        
        function showErrorNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                background: #ef4444; color: white; padding: 12px 20px;
                border-radius: 8px; font-size: 14px; font-weight: 500;
                box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
    </script>
</body>
</html>